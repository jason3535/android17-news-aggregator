<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nothing 竞品追踪 - Android 17 & iOS 27</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>●</text></svg>">
</head>
<body>
    <div class="container">
        <!-- 右上角翻译按钮 -->
        <button class="translate-btn active" id="translateBtn" onclick="toggleLanguage()">
            <span class="translate-icon">译</span>
            <span class="translate-label" id="translateLabel">中 → EN</span>
        </button>

        <header>
            <div class="brand-badge">● Nothing 竞品追踪</div>
            <h1>Android 17 & iOS 27</h1>
            <p class="subtitle" data-en="Competitor Software Update Tracking // Real-time News Feed" data-zh="竞品软件更新追踪 // 实时新闻聚合">竞品软件更新追踪 // 实时新闻聚合</p>
            <div class="header-actions">
                <span class="last-updated" id="lastUpdated" data-en="Initializing..." data-zh="初始化中...">初始化中...</span>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshNews()">
                    <span class="refresh-icon">↻</span>
                    <span data-en="Refresh" data-zh="刷新">刷新</span>
                </button>
            </div>
        </header>

        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span class="stat-value" id="totalCount">--</span>
                <span class="stat-label" data-en="Total" data-zh="总计">总计</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="androidCount">--</span>
                <span class="stat-label" data-en="Android 17" data-zh="Android 17">Android 17</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="iosCount">--</span>
                <span class="stat-label" data-en="iOS 27" data-zh="iOS 27">iOS 27</span>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" data-filter="all" data-en="● All" data-zh="● 全部">● 全部</button>
            <button class="filter-btn" data-filter="android" data-en="Android 17" data-zh="Android 17">Android 17</button>
            <button class="filter-btn" data-filter="ios" data-en="iOS 27" data-zh="iOS 27">iOS 27</button>
        </div>

        <main class="feed" id="newsFeed">
            <div class="loading">
                <div class="spinner"></div>
                <p data-en="Loading data..." data-zh="加载中...">Loading data...</p>
            </div>
        </main>

        <footer>
            <p data-en="Data Sources // Android Authority • 9to5Google • XDA" data-zh="数据来源 // Android Authority • 9to5Google • XDA">Data Sources // Android Authority • 9to5Google • XDA</p>
            <p data-en="Auto Refresh // 1 Hour Interval" data-zh="自动刷新 // 每小时更新">Auto Refresh // 1 Hour Interval</p>
        </footer>
    </div>

    <!-- 分享弹窗 -->
    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <h3 data-en="Share News" data-zh="分享新闻">分享新闻</h3>
                <button class="share-modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="share-modal-body">
                <div class="share-badge-nothing">
                    ● Nothing 竞品追踪
                </div>
                <p class="share-hint" data-en="Copy the link below to share with colleagues and friends" data-zh="复制下方链接分享给同事和朋友">复制下方链接分享给同事和朋友</p>
                <div class="share-link-container">
                    <input type="text" id="shareLink" readonly class="share-link-input">
                    <button onclick="copyShareLink()" class="copy-btn">
                        <span id="copyBtnText" data-en="Copy" data-zh="复制">复制</span>
                    </button>
                </div>
                <div id="shareSuccess" class="share-success" style="display: none;">
                    <span data-en="✓ Link copied!" data-zh="✓ 链接已复制！">✓ 链接已复制！</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let newsData = [];
        let currentLang = 'zh';  // 默认中文
        let translationCache = {};  // 缓存翻译结果
        // 从localStorage加载缓存
        try {
            const savedCache = localStorage.getItem('translationCache');
            if (savedCache) {
                translationCache = JSON.parse(savedCache);
            }
        } catch (e) {
            console.log('无法加载翻译缓存:', e);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateUILanguage(); // 设置界面为默认语言（中文）
            loadNews();
            setupFilters();
        });

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderNews();
                });
            });
        }

        // 切换语言
        async function toggleLanguage() {
            const btn = document.getElementById('translateBtn');
            const label = document.getElementById('translateLabel');

            if (currentLang === 'en') {
                currentLang = 'zh';
                label.textContent = '中 → EN';
                btn.classList.add('active');
            } else {
                currentLang = 'en';
                label.textContent = 'EN → 中';
                btn.classList.remove('active');
            }

            // 更新界面静态文字
            updateUILanguage();

            // 重新渲染新闻（带翻译）
            await renderNews();
        }

        // 更新界面语言
        function updateUILanguage() {
            document.querySelectorAll('[data-en][data-zh]').forEach(el => {
                const text = currentLang === 'zh' ? el.dataset.zh : el.dataset.en;
                el.textContent = text;
            });
        }

        // 翻译单条文本
        async function translateText(text, targetLang) {
            const cacheKey = `${text}_${targetLang}`;

            // 检查内存缓存
            if (translationCache[cacheKey]) {
                return translationCache[cacheKey];
            }

            // 检查是否需要实时翻译（如果有预翻译内容应该不会走到这里）
            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, target: targetLang === 'zh' ? 'zh-CN' : 'en' })
                });
                const data = await response.json();
                translationCache[cacheKey] = data.translated;

                // 保存到localStorage
                try {
                    localStorage.setItem('translationCache', JSON.stringify(translationCache));
                } catch (e) {
                    console.log('无法保存翻译缓存:', e);
                }

                return data.translated;
            } catch (error) {
                console.error('Translation failed:', error);
                return text;
            }
        }

        async function loadNews() {
            try {
                const response = await fetch('/api/news');
                const data = await response.json();
                newsData = data.items || [];

                // Update stats
                document.getElementById('totalCount').textContent = data.total_count || 0;
                document.getElementById('androidCount').textContent = data.android_count || 0;
                document.getElementById('iosCount').textContent = data.ios_count || 0;

                // Update timestamp
                if (data.last_updated) {
                    const date = new Date(data.last_updated);
                    const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const el = document.getElementById('lastUpdated');
                    el.dataset.en = `Updated // ${timeStr}`;
                    el.dataset.zh = `更新于 // ${timeStr}`;
                    el.textContent = currentLang === 'zh' ? el.dataset.zh : el.dataset.en;
                }

                await renderNews();
            } catch (error) {
                console.error('Load failed:', error);
                document.getElementById('newsFeed').innerHTML =
                    `<div class="error">${currentLang === 'zh' ? '连接失败 // 请重试' : 'Connection failed // Retry'}</div>`;
            }
        }

        async function refreshNews() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span class="refresh-icon spinning">↻</span> <span>${currentLang === 'zh' ? '同步中...' : 'Syncing...'}</span>`;

            try {
                const response = await fetch('/api/refresh');
                const data = await response.json();
                newsData = data.items || [];

                // Update stats
                document.getElementById('totalCount').textContent = data.total_count || 0;
                document.getElementById('androidCount').textContent = data.android_count || 0;
                document.getElementById('iosCount').textContent = data.ios_count || 0;

                // Update timestamp
                if (data.last_updated) {
                    const date = new Date(data.last_updated);
                    const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const el = document.getElementById('lastUpdated');
                    el.dataset.en = `Updated // ${timeStr}`;
                    el.dataset.zh = `更新于 // ${timeStr}`;
                    el.textContent = currentLang === 'zh' ? el.dataset.zh : el.dataset.en;
                }

                await renderNews();
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span class="refresh-icon">↻</span> <span data-en="Refresh" data-zh="刷新">${currentLang === 'zh' ? '刷新' : 'Refresh'}</span>`;
            }
        }

        async function renderNews() {
            const feed = document.getElementById('newsFeed');
            let filteredNews = newsData;

            if (currentFilter !== 'all') {
                filteredNews = newsData.filter(item => item.platform === currentFilter);
            }

            if (filteredNews.length === 0) {
                feed.innerHTML = `<div class="empty">${currentLang === 'zh' ? '暂无数据' : 'No data available'}</div>`;
                return;
            }

            // 检查是否需要显示翻译中状态
            let needsTranslation = false;
            if (currentLang === 'zh') {
                // 检查是否有新闻需要实时翻译
                needsTranslation = filteredNews.some(item =>
                    item.type === 'news' && (!item.title_translated || !item.summary_translated)
                );
                if (needsTranslation) {
                    feed.innerHTML = '<div class="loading"><div class="spinner"></div><p>翻译中...</p></div>';
                }
            }

            // 处理每条新闻
            const newsHTML = [];
            for (const item of filteredNews) {
                const sourceClass = item.source.replace(/\s+/g, '-').toLowerCase();
                const badgeText = item.type === 'leaker' ? 'LKR' :
                    item.source === 'Android Authority' ? 'AA' :
                    item.source === '9to5Google' ? '9TO5' :
                    item.source === 'XDA Developers' ? 'XDA' : item.source_icon;

                let title = item.title;
                let summary = item.summary;

                // 如果是中文模式，优先使用预翻译内容
                if (currentLang === 'zh' && item.type === 'news') {
                    // 检查是否有预翻译的字段
                    if (item.title_translated && item.summary_translated) {
                        title = item.title_translated;
                        summary = item.summary_translated;
                    } else {
                        // 没有预翻译内容，使用实时翻译
                        title = await translateText(item.title, 'zh');
                        summary = await translateText(item.summary, 'zh');
                    }
                }

                const readMoreText = item.type === 'leaker'
                    ? (currentLang === 'zh' ? '查看主页' : 'View Profile')
                    : (currentLang === 'zh' ? '阅读全文' : 'Read More');

                // 缩略图 HTML - 始终显示容器
                const thumbnailHTML = `<div class="news-thumbnail">
                    ${item.image ? `<img src="${item.image}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
                </div>`;

                const itemIndex = filteredNews.indexOf(item);
                const shareButtonText = currentLang === 'zh' ? '分享' : 'Share';

                newsHTML.push(`
                    <article class="news-card ${item.type} ${item.image ? 'has-image' : ''}">
                        ${thumbnailHTML}
                        <div class="news-content">
                            <div class="news-header">
                                <span class="source-badge ${sourceClass}">${badgeText}</span>
                                <span class="news-date">${item.date}</span>
                            </div>
                            <h2 class="news-title">
                                <a href="${item.url}" target="_blank" rel="noopener">${title}</a>
                            </h2>
                            <p class="news-summary">${summary}</p>
                            <div class="news-actions">
                                <a href="${item.url}" target="_blank" rel="noopener" class="read-more">
                                    ${readMoreText}
                                </a>
                                <button class="share-btn" onclick="shareNews(${itemIndex})" title="${shareButtonText}">
                                    <span class="share-icon">⤴</span>
                                    <span class="share-text">${shareButtonText}</span>
                                </button>
                            </div>
                        </div>
                    </article>
                `);
            }

            feed.innerHTML = newsHTML.join('');
        }

        // 分享功能
        async function shareNews(index) {
            let filteredNews = newsData;
            if (currentFilter !== 'all') {
                filteredNews = newsData.filter(item => item.platform === currentFilter);
            }

            const newsItem = filteredNews[index];
            if (!newsItem) {
                alert(currentLang === 'zh' ? '新闻不存在' : 'News not found');
                return;
            }

            try {
                // 纯前端分享方案（适配GitHub Pages）
                const shareData = {
                    title: newsItem.title,
                    title_translated: newsItem.title_translated,
                    summary: newsItem.summary,
                    summary_translated: newsItem.summary_translated,
                    url: newsItem.url,
                    image: newsItem.image,
                    source: newsItem.source,
                    source_icon: newsItem.source_icon,
                    date: newsItem.date,
                    type: newsItem.type
                };

                // Base64编码（URL安全）
                const encodedData = btoa(encodeURIComponent(JSON.stringify(shareData)));

                // 生成分享URL
                const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
                const shareUrl = `${baseUrl}share.html?d=${encodedData}`;

                showShareModal(shareUrl);
            } catch (error) {
                console.error('Share failed:', error);
                alert(currentLang === 'zh' ? '分享失败，请重试' : 'Share failed, please retry');
            }
        }

        function showShareModal(shareUrl) {
            const modal = document.getElementById('shareModal');
            const linkInput = document.getElementById('shareLink');
            linkInput.value = shareUrl;
            modal.style.display = 'flex';
            updateUILanguage(); // 更新弹窗内的文字
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            const successMsg = document.getElementById('shareSuccess');
            modal.style.display = 'none';
            successMsg.style.display = 'none';

            // 重置复制按钮文字
            const copyBtnText = document.getElementById('copyBtnText');
            copyBtnText.textContent = currentLang === 'zh' ? '复制' : 'Copy';
        }

        async function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            const copyBtnText = document.getElementById('copyBtnText');
            const successMsg = document.getElementById('shareSuccess');

            try {
                await navigator.clipboard.writeText(linkInput.value);
                copyBtnText.textContent = currentLang === 'zh' ? '已复制！' : 'Copied!';
                successMsg.style.display = 'block';

                setTimeout(() => {
                    copyBtnText.textContent = currentLang === 'zh' ? '复制' : 'Copy';
                    successMsg.style.display = 'none';
                }, 2000);
            } catch (error) {
                // 降级方案：使用 select + execCommand
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // 移动端兼容
                document.execCommand('copy');

                copyBtnText.textContent = currentLang === 'zh' ? '已复制！' : 'Copied!';
                successMsg.style.display = 'block';

                setTimeout(() => {
                    copyBtnText.textContent = currentLang === 'zh' ? '复制' : 'Copy';
                    successMsg.style.display = 'none';
                }, 2000);
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('shareModal');
            if (event.target === modal) {
                closeShareModal();
            }
        }
    </script>
</body>
</html>
